name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build Core
        run: |
          yarn install
          yarn build

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch gh-pages branch
        continue-on-error: true
        run: |
          git fetch origin gh-pages:gh-pages || echo "No gh-pages branch yet"

      - name: Preserve old versions
        continue-on-error: true
        run: |
          if git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
            if [ -d "versions" ]; then
              cp -r versions /tmp/versions-backup
              echo "âœ… Backed up old versions"
            fi
            if [ -f "versions.json" ]; then
              cp versions.json /tmp/versions.json
              echo "âœ… Backed up versions.json"
            fi
            git checkout main
          fi

      - name: Build Documentation
        run: yarn docs:build

      - name: Restore and update versions
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "ğŸ“¦ Current version: v$VERSION"
          
          # æ¢å¤æ—§ç‰ˆæœ¬
          if [ -d "/tmp/versions-backup" ]; then
            mkdir -p docs/.vitepress/dist/versions
            cp -r /tmp/versions-backup/* docs/.vitepress/dist/versions/
            echo "âœ… Restored old versions"
          fi
          
          # åˆ›å»ºå½“å‰ç‰ˆæœ¬ç›®å½•
          mkdir -p "docs/.vitepress/dist/versions/v$VERSION"
          
          # å¤åˆ¶å½“å‰æ„å»ºåˆ°ç‰ˆæœ¬ç›®å½•ï¼ˆæ’é™¤ versions ç›®å½•æœ¬èº«ï¼‰
          rsync -av --exclude='versions' docs/.vitepress/dist/ "docs/.vitepress/dist/versions/v$VERSION/"
          
          # ç”Ÿæˆç‰ˆæœ¬åˆ—è¡¨ï¼ˆæ”¾åœ¨æ ¹ç›®å½•ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ /hyper-scheduler/versions.json è®¿é—®ï¼‰
          VERSIONS_FILE="docs/.vitepress/dist/versions.json"
          echo "[" > "$VERSIONS_FILE"
          FIRST=true
          # æŒ‰ç‰ˆæœ¬å·å€’åºæ’åˆ—
          if [ -d "docs/.vitepress/dist/versions" ]; then
            for dir in $(ls -1 docs/.vitepress/dist/versions/ | sort -V -r); do
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                echo "," >> "$VERSIONS_FILE"
              fi
              echo "  \"$dir\"" >> "$VERSIONS_FILE"
            done
          else
            # å¦‚æœæ²¡æœ‰ versions ç›®å½•ï¼Œåªæ·»åŠ å½“å‰ç‰ˆæœ¬
            echo "  \"v$VERSION\"" >> "$VERSIONS_FILE"
          fi
          echo "" >> "$VERSIONS_FILE"
          echo "]" >> "$VERSIONS_FILE"
          
          echo "âœ… Version list generated:"
          cat "$VERSIONS_FILE"
          
          # åŒæ—¶æ›´æ–° public ç›®å½•ä¸­çš„ç‰ˆæœ¬æ–‡ä»¶ï¼ˆç”¨äºä¸‹æ¬¡æ„å»ºï¼‰
          cp "$VERSIONS_FILE" docs/public/versions.json

      - name: Build React Demo
        run: |
          cd examples/react-demo
          yarn install
          yarn build
          # ç§»åŠ¨æ„å»ºäº§ç‰©åˆ°æ–‡æ¡£è¾“å‡ºç›®å½•çš„å­æ–‡ä»¶å¤¹
          mkdir -p ../../docs/.vitepress/dist/examples/react-demo
          cp -r dist/* ../../docs/.vitepress/dist/examples/react-demo/

      - name: Build Vue Demo
        run: |
          cd examples/vue-demo
          yarn install
          yarn build
          # ç§»åŠ¨æ„å»ºäº§ç‰©åˆ°æ–‡æ¡£è¾“å‡ºç›®å½•çš„å­æ–‡ä»¶å¤¹
          mkdir -p ../../docs/.vitepress/dist/examples/vue-demo
          cp -r dist/* ../../docs/.vitepress/dist/examples/vue-demo/

      - name: Build Browser Example
        run: |
          mkdir -p docs/.vitepress/dist/examples/browser
          # å¤åˆ¶ HTML
          cp examples/browser/index.html docs/.vitepress/dist/examples/browser/
          # å¤åˆ¶æ ¸å¿ƒåº“æ„å»ºäº§ç‰© (Browser ç¤ºä¾‹å¼ºä¾èµ–è¿™ä¸ªè·¯å¾„: ../../dist/index.umd.cjs)
          # ä¸ºäº†ä¿æŒè·¯å¾„å¼•ç”¨æœ‰æ•ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨ docs/.vitepress/dist å†…éƒ¨é‡å»ºç›®å½•ç»“æ„
          # æµè§ˆå™¨ç¤ºä¾‹å¼•ç”¨æ˜¯ src="../../dist/index.umd.cjs"
          # éƒ¨ç½²åè·¯å¾„ä¸º /examples/browser/index.html
          # æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°† dist æ”¾åœ¨ /dist
          mkdir -p docs/.vitepress/dist/dist
          cp dist/index.umd.js docs/.vitepress/dist/dist/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
