# 功能规范: 更新 DevTools UI

**功能分支**: `001-update-devtools-ui`
**创建日期**: 2025年11月27日
**状态**: 草稿
**输入**: 用户描述: "@origin-prd/ui-design.md 请根据此设计方案修改devtools的ui界面，你可以考虑使用其他框架进行实现，要越简单越好。"

## 澄清事项

### 2025-11-27
- Q: Should the "Settings" tab be included in the MVP despite lacking defined configuration options beyond the theme toggle? -> A: Option A - Exclude Settings Tab: Only implement the Theme Toggle in the header. Defer complex settings UI to a future iteration.
- Q: For handling user interactions within the Shadow DOM, which approach aligns best with the "simple as possible" and "lightweight" (NFR-002) requirements? -> A: Option A - 原生事件委托：直接在 Shadow Root 或组件容器上使用 `addEventListener`，并根据 `event.composedPath()` 处理点击等交互。无额外运行时开销。
- Q: FR-007 提到“最近 N 次执行历史”。为了确保内存稳定性 (NFR-001)，每个任务的“N”条执行日志的最大硬限制应该是什么，以避免旧日志被轮换掉？ -> A: Option C - 可配置，推荐最大数量为 50。

## 用户场景与测试 *(必填)*

### 用户故事 1 - 查看任务概览与状态 (优先级: P1)

作为一名开发者，我希望在一个统一的面板中查看所有调度任务的实时状态、执行频率和最后运行结果，以便快速了解系统的健康状况。

**为何此优先级**: 这是 DevTools 的核心价值，提供“上帝视角”来监控调度器。

**独立测试**: 启动包含多个不同状态任务的应用，打开 DevTools，验证列表是否正确显示所有任务及其状态、ID、Tag 和统计信息。

**验收场景**:

1. **鉴于** 应用正在运行多个任务（运行中、暂停、已停止），**当** 我点击悬浮触发球打开面板，**则** 我应看到一个包含所有任务的表格，列出 ID、Tag、当前状态（图标+文字）、间隔和最后运行时间。
2. **鉴于** 任务状态在后台发生变化（如从运行变为暂停），**当** 我保持面板打开，**则** UI 应自动更新以反映最新状态（无需手动刷新）。

---

### 用户故事 2 - 手动控制任务执行 (优先级: P1)

作为一名开发者，我希望能够手动触发、暂停、恢复或删除特定任务，以便在调试过程中模拟特定场景或清理环境，而无需修改代码或重启应用。

**为何此优先级**: 提供交互能力，使 DevTools 不仅仅是只读的显示器，而是调试工具。

**独立测试**: 针对特定任务点击“触发”或“暂停”，观察任务实际行为及 UI 状态反馈。

**验收场景**:

1. **鉴于** 某任务配置为每 1 小时运行一次，**当** 我点击该任务行中的 "Trigger" (▶️) 按钮，**则** 该任务应立即执行一次，且“最后运行时间”和“执行次数”应立即更新。
2. **鉴于** 某任务正在运行，**当** 我点击 "Pause" (⏸️) 按钮，**则** 该任务应停止按计划调度，状态变为“已暂停”。
3. **鉴于** 某任务已暂停，**当** 我点击 "Resume" (▶️) 按钮，**则** 该任务应恢复按计划调度。

---

### 用户故事 3 - 分析任务详细历史与性能 (优先级: P2)

作为一名开发者，我希望能深入查看单个任务的配置详情和最近的执行历史（耗时、偏差、结果），以便诊断性能瓶颈或偶发错误。

**为何此优先级**: 当概览显示异常时，需要深入挖掘原因。

**独立测试**: 点击任务列表中的某一行，验证是否进入详情视图并显示正确的数据。

**验收场景**:

1. **鉴于** 我在任务列表视图，**当** 我点击 "heartbeat-001" 任务行，**则** 视图应切换到详情面板，显示该任务的完整配置（JSON/对象视图）。
2. **鉴于** 进入详情面板，**当** 我查看历史记录区域，**则** 我应看到最近 N 次执行的列表，包含开始时间、耗时、时间漂移 (Drift) 和执行结果（成功/失败）。N 的数量应可配置，但建议默认或最大值为 50。
3. **鉴于** 某次执行失败，**当** 我查看历史记录，**则** 该条目应有明显的错误标记。

---

### 用户故事 4 - 可视化任务时间轴 (优先级: P3)

作为一名开发者，我希望在一个时间轴上直观地看到任务触发的分布和重叠情况，以便识别调度冲突或过于密集的执行时段。

**为何此优先级**: 这是一个高级优化功能，用于解决复杂的并发问题。

**独立测试**: 切换到 Timeline 标签，观察图形是否随时间推进而更新。

**验收场景**:

1. **鉴于** 面板已打开，**当** 我点击顶部导航的 "Timeline" 标签，**则** 视图应切换到时间轴模式。
2. **鉴于** 多个任务正在运行，**当** 观察时间轴，**则** 我应看到不同任务在时间轴上的执行点（瞬间任务）或条形块（耗时任务），且时间轴随时间自动滚动/更新。

### 边缘情况

- 当任务列表为空时，应显示友好的空状态提示。
- 当任务 ID 或 Tag 过长时，表格布局应合理截断或换行，不破坏整体布局。
- 当 DevTools 所在宿主页面样式非常复杂（如设置了全局 `* { ... }`）时，DevTools 的样式不应受到影响（Shadow DOM 隔离）。
- 当屏幕尺寸极小（如移动端视图）时，面板应自适应或允许水平滚动，保证核心功能可用。

## 需求 *(必填)*

### 功能需求

- **FR-001 (入口)**: 系统必须提供一个默认收起的悬浮触发器（Floating Trigger），点击后展开主面板。
- **FR-002 (主面板结构)**: 主面板必须包含顶部导航栏（Header）、内容区域（Content）和底部信息栏（Footer）。
- **FR-003 (全局状态)**: 顶部栏必须实时显示全局任务统计（活跃/总数）和主线程 FPS 监控（颜色编码：绿/黄/红）。
- **FR-004 (主题切换)**: 系统必须支持深色/浅色模式切换，并能自动适应或手动控制。不需实现独立的“设置”标签页，主题切换按钮位于头部即可。
- **FR-005 (任务列表)**: 系统必须提供表格视图展示所有注册任务，列包含：ID/Tags、状态、间隔(Interval)、执行次数(Count)、最后运行时间(Last Run)、操作列(Actions)。
- **FR-006 (任务操作)**: 操作列必须提供“手动触发”、“暂停/恢复”、“删除”功能的交互按钮。
- **FR-007 (任务详情)**: 点击任务行必须进入详情视图，展示任务配置快照和最近 N 次执行历史（含耗时、漂移、状态）。N 的数量应可配置，建议默认或最大值为 50。
- **FR-008 (时间轴)**: 系统必须提供时间轴视图，以可视化方式（点或条）展示最近一段时间内的任务执行情况。
- **FR-009 (样式隔离)**: 整个 UI 组件必须封装在 Shadow DOM 中，防止样式污染和被污染。交互事件应通过原生事件委托机制（在 Shadow Root 或组件容器上添加监听器）进行处理。
- **FR-010 (快捷键)**: 系统应支持快捷键（默认 Ctrl+H）切换面板的显示/隐藏。

### 非功能性需求

- **NFR-001 (性能)**: DevTools 的渲染和数据刷新不应明显降低宿主应用的性能（FPS 占用低于 5%）。
- **NFR-002 (体积)**: DevTools 组件的打包体积应尽可能小，避免引入过大的第三方库（如完整版 ECharts 或大型 UI 框架），保持轻量级。
- **NFR-003 (响应式)**: UI 必须适配不同尺寸的视口，支持面板拖拽调整大小。
- **NFR-004 (刷新率)**: 界面数据刷新应采用节流机制（如默认 500ms），避免过度渲染。

### 关键实体

- **TaskSnapshot**: 代表任务在某一时刻的状态快照（ID, Tags, Status, Config, Stats）。
- **ExecutionLog**: 单次任务执行的记录（StartTime, Duration, Drift, Result, Error）。

## 成功标准 *(必填)*

### 可衡量结果

- **SC-001**: 开发者可以在 2 次点击内（打开面板 -> 点击触发）手动触发任意任务。
- **SC-002**: DevTools 面板在 1000 个任务记录下的渲染延迟不超过 100ms。
- **SC-003**: 在开启 DevTools 的情况下，宿主页面的主线程 FPS 下降不超过 3 帧。
- **SC-004**: 90% 的样式规则通过 Shadow DOM 隔离，不受外部全局 CSS（如 Bootstrap/Tailwind reset）的干扰。
- **SC-005**: 能够清晰区分“耗时任务”（Duration > Threshold）和“瞬间任务”，并在 UI 上直观体现。