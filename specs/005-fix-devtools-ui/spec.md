# 功能规范: 修复 DevTools UI 问题

**功能分支**: `005-fix-devtools-ui`
**创建日期**: 2025年11月27日
**状态**: 草稿
**输入**: 用户描述: "1.这里的 Timeline 没有展示出来，时间线也没有展示出来；2.如果页面上操作这些调度器，DevTools没有更新;3.Task列表的操作展示得不对，操作icon看起来怪怪的;4.主题的颜色没有发生变化，还有字体哪些。5.devtools 支持右侧展示和底部展示，跟F12长得差不多。"

## 澄清事项

### 2025-11-27
- Q: How should users switch between docking positions (Right/Bottom)? -> A: Option A - Include in header: Add a dedicated icon button in the top navigation bar to cycle between Right and Bottom docking.

## 用户场景与测试 *(必填)*

### 用户故事 1 - 正确显示时间轴与时间线 (优先级: P1)

作为一名开发者，我希望在 DevTools 的 Timeline 视图中清晰地看到任务执行的时间轴和当前时间线，以便分析任务的并发和调度情况。

**为何此优先级**: 当前功能失效（“没有展示出来”），属于严重 Bug 修复，直接影响 DevTools 的核心分析能力。

**独立测试**: 打开 DevTools 切换到 Timeline 标签，确认是否能看到表示任务执行的条形图以及一条随时间移动的当前时间线。

**验收场景**:

1. **鉴于** DevTools 已打开且有任务正在运行，**当** 我切换到 "Timeline" 标签页，**则** 我应看到一个带有时间刻度坐标轴的画布。
2. **鉴于** 处于 Timeline 视图，**当** 任务执行完成，**则** 画布上应实时出现对应的任务执行条（条形块）。
3. **鉴于** 处于 Timeline 视图，**当** 等待几秒钟，**则** 应看到一条指示当前时间的垂直线（或类似标记）随时间向右移动（或画布向左滚动）。

---

### 用户故事 2 - 实时同步调度器状态 (优先级: P1)

作为一名开发者，我希望当我在宿主页面代码中操作调度器（如启动/停止任务）时，DevTools 能即时反映这些变化，而不需要我手动刷新或重新打开面板。

**为何此优先级**: 修复数据同步问题，确保 DevTools 显示的是真实且即时的系统状态。

**独立测试**: 在控制台或页面按钮触发 `scheduler.stopTask()`，观察 DevTools 列表中对应任务的状态图标是否立即更新。

**验收场景**:

1. **鉴于** DevTools 处于打开状态，**当** 我在宿主页面调用 `scheduler.createTask(...)` 添加新任务，**则** DevTools 的任务列表应立即显示该新任务。
2. **鉴于** 某任务状态为 "Running"，**当** 宿主页面代码调用 `scheduler.stopTask(id)`，**则** DevTools 中该任务的状态图标应立即变为 "Stopped"。
3. **鉴于** 任务正在执行，**当** 任务完成一次执行周期，**则** DevTools 中的 "Last Run" 和 "Count" 字段应自动更新。

---

### 用户故事 3 - 优化任务列表操作与图标显示 (优先级: P2)

作为一名开发者，我希望任务列表的操作按钮（触发、暂停、删除等）布局合理且图标显示正常，以便我能直观、准确地控制任务。

**为何此优先级**: 修复 UI 显示 Bug（“icon看起来怪怪的”），提升工具的可用性和专业度。

**独立测试**: 检查任务列表每一行的操作列，确认图标是否对齐、清晰，且点击后能触发正确的操作。

**验收场景**:

1. **鉴于** 查看任务列表，**当** 我观察操作列，**则** 所有按钮图标（如播放、暂停、删除）应大小一致、垂直居中，且没有奇怪的错位或乱码。
2. **鉴于** 任务处于不同状态（如已暂停），**当** 我查看操作按钮，**则** 应显示正确的上下文按钮（如显示“恢复”而不是“暂停”）。

---

### 用户故事 4 - 修复主题切换与字体样式 (优先级: P2)

作为一名开发者，我希望 DevTools 的主题切换功能能够真正改变界面的颜色，且字体样式应符合设计（如等宽字体用于代码/ID），确保阅读体验。

**为何此优先级**: 修复样式 Bug，保证视觉体验的一致性和可读性。

**独立测试**: 点击主题切换按钮，验证背景色、文字颜色是否发生明显变化。

**验收场景**:

1. **鉴于** 当前为浅色主题，**当** 我点击“切换主题”按钮，**则** 面板背景应变为深色，文字变为浅色，且所有组件（列表、头部、详情）颜色同步更新。
2. **鉴于** DevTools 已加载，**当** 我查看任务 ID 或配置 JSON，**则** 这些文本应使用等宽字体（Monospace）显示。

---

### 用户故事 5 - 支持面板停靠位置切换 (优先级: P3)

作为一名开发者，我希望能够将 DevTools 面板停靠在屏幕右侧或底部，以便根据我的屏幕空间和调试习惯灵活调整布局。

**为何此优先级**: 这是一个新功能增强（Feature Request），提升灵活性，但优先级低于核心 Bug 修复。

**独立测试**: 在 DevTools 头部找到布局切换按钮，点击后观察面板位置变化。

**验收场景**:

1. **鉴于** 面板当前停靠在右侧（默认），**当** 我点击头部导航栏的停靠切换按钮，**则** 面板应移动到屏幕底部，宽度变为 100%，高度可调整。
2. **鉴于** 面板停靠在底部，**当** 我再次点击停靠切换按钮，**则** 面板应恢复到屏幕右侧，高度变为 100%，宽度可调整。

### 边缘情况

- 当 Timeline 数据量非常大时，Canvas/SVG 渲染不应导致页面卡顿。
- 当切换停靠位置时，面板内容的布局（如列表列宽）应自动适应新的容器尺寸。
- 如果宿主页面强制覆盖了全局 CSS（如 `!important`），DevTools 的 Shadow DOM 样式隔离应确保自身样式不受影响。

## 需求 *(必填)*

### 功能需求

- **FR-001 (Timeline 修复)**: 必须修复 Timeline 组件的渲染逻辑，确保任务条形图和当前时间线指针能正确绘制并随时间更新。
- **FR-002 (数据同步)**: 必须完善 DevTools 与 Scheduler 之间的事件监听机制，确保外部对 Scheduler 的操作（增删改查、状态变更）能实时推送到 DevTools Store 并触发 UI 更新。
- **FR-003 (UI/Icons 修复)**: 必须修正任务列表操作列的 CSS 样式，确保 SVG 图标渲染大小正确、位置对齐，并根据任务状态正确显示 播放/暂停 按钮的互斥逻辑。
- **FR-004 (样式修复)**: 必须检查 CSS 变量的注入和应用逻辑，确保主题切换（Light/Dark）能生效；必须为关键文本元素（ID、代码）指定正确的 Font-Family。
- **FR-005 (停靠布局)**: 系统必须提供面板停靠位置切换功能（Dock to Right / Dock to Bottom），并根据停靠位置调整面板的 CSS 布局属性（宽/高/定位）。切换按钮应位于 DevTools 的顶部导航栏。

### 非功能性需求

- **NFR-001 (性能)**: Timeline 的实时重绘（如果使用 requestAnimationFrame）不应占用过高的 CPU，需考虑在面板隐藏时停止渲染循环。
- **NFR-002 (兼容性)**: 停靠位置切换应在不同屏幕尺寸下表现良好（响应式布局）。

### 关键实体

- **DevToolsStore**: 需要扩展字段以支持 `dockPosition` ('right' | 'bottom')。
- **ThemeConfig**: 需确保 CSS 变量定义完整覆盖所有 UI 组件。

## 成功标准 *(必填)*

### 可衡量结果

- **SC-001**: 在 Timeline 视图下，当前时间线每秒更新位置，且误差不超过 100ms。
- **SC-002**: 外部触发 `scheduler.stopTask()` 后，DevTools 界面在 100ms 内反映状态变化。
- **SC-003**: 主题切换操作在 50ms 内完成渲染更新。
- **SC-004**: 支持右侧和底部两种停靠模式，且切换过程无明显的布局抖动。